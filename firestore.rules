rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAdmin() {
      return request.auth != null
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    function isParticipant(uid, participants) {
      return participants != null && uid in participants;
    }

    function isTwoStringList(l) {
      return l is list && l.size() == 2 && l[0] is string && l[1] is string;
    }

    match /users/{uid} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null && request.auth.uid == uid;
      allow delete: if isAdmin();
    }

    match /plans/{planId} {
      allow read: if request.auth != null;
      allow create, update, delete: if isAdmin();
    }

    match /subscriptions/{subId} {
      allow read: if request.auth != null && (resource.data.uid == request.auth.uid || isAdmin());
      allow create, update, delete: if isAdmin();
    }

    match /payments/{paymentId} {
      allow create: if request.auth != null
                    && request.resource.data.uid == request.auth.uid
                    && request.resource.data.status == 'pending';
      allow read: if request.auth != null && (resource.data.uid == request.auth.uid || isAdmin());
      allow update, delete: if isAdmin();
    }

    match /matchingRounds/{roundId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();

      match /assignments/{girlUid} {
        allow read: if request.auth != null && (request.auth.uid == girlUid || isAdmin());
        allow write: if isAdmin();
      }
    }

    match /likes/{likeId} {
      allow create: if request.auth != null
                    && (
                      request.resource.data.likingUserUid == request.auth.uid
                      || request.resource.data.likerUid == request.auth.uid
                    )
                    && request.resource.data.likedUserUid is string
                    && request.resource.data.roundId is string;
      allow read: if request.auth != null;
      allow update, delete: if isAdmin()
                            || (request.auth != null && resource.data.likingUserUid == request.auth.uid)
                            || (request.auth != null && resource.data.likerUid == request.auth.uid);
    }

    match /matches/{matchId} {
      allow read: if request.auth != null
                  && ((resource.data.participants != null && request.auth.uid in resource.data.participants) || isAdmin());
      allow create, update, delete: if isAdmin();
    }

    // Chat
    match /threads/{threadId} {
      // Each thread may include optional moderation fields:
      // blockedUserUid: string | null        // the user who is blocked (cannot send)
      // blockedSetByUid: string | null       // who set the block (the blocker)
      // blockedAt: timestamp | null

      allow read: if request.auth != null && (isAdmin() || isParticipant(request.auth.uid, resource.data.participants));

      allow create: if request.auth != null
                    && isTwoStringList(request.resource.data.participants)
                    && request.auth.uid in request.resource.data.participants
                    && request.resource.data.createdAt != null
                    && request.resource.data.updatedAt != null;

      // Allow participants to update thread meta, but not participants array.
      // This permits setting/clearing blocked fields by either participant.
      allow update: if isAdmin()
                    || (
                      request.auth != null
                      && isParticipant(request.auth.uid, resource.data.participants)
                      && request.resource.data.participants == resource.data.participants
                    );

      allow delete: if isAdmin();

      match /messages/{messageId} {
        allow read: if request.auth != null
                    && (isAdmin()
                        || isParticipant(request.auth.uid, get(/databases/$(database)/documents/threads/$(threadId)).data.participants));

        // Disallow sending if the current user is the blocked user in this thread
        allow create: if request.auth != null
                      && isParticipant(request.auth.uid, get(/databases/$(database)/documents/threads/$(threadId)).data.participants)
                      && get(/databases/$(database)/documents/threads/$(threadId)).data.blockedUserUid != request.auth.uid
                      && request.resource.data.senderUid == request.auth.uid
                      && request.resource.data.text is string
                      && request.resource.data.createdAt != null;

        allow update, delete: if isAdmin();
      }
    }

    // Reports (clients can create; admins can read/manage)
    match /reports/{reportId} {
      allow create: if request.auth != null
                    && request.resource.data.reporterUid == request.auth.uid
                    && request.resource.data.reportedUid is string
                    && request.resource.data.threadId is string
                    && request.resource.data.reason is string
                    && request.resource.data.createdAt != null;
      allow read, update, delete: if isAdmin();
    }
  }
}